const app=new Vue({el:"#app",delimiters:["${","}"],vuetify:new Vuetify,pinia:Pinia.createPinia(),data(){return{bill:{entries:[],debitAccounts:[],debitAccountsCopy:[],creditAccounts:[],creditAccountsCopy:[],debitAccountBalance:null,creditsAccountBalance:null,currencies:[],currenciesCopy:[],partners:[],partnersCopy:[],bills:[],billsCopy:[],selectedBill:0,headers:[{text:"Date de l'opération",align:"start",sortable:!0,value:"dateOperation"},{text:"Compte",value:"account"},{text:"Libellé",value:"label"},{text:"Montant en devise",value:"amount_foreign"},{text:"Debit",value:"debit"},{text:"Crédit",value:"credit",sortable:!1}],countDebitAccount:1,countCreditAccount:1,menuBill:!1,menuDeadline:!1,loading:!1,creditLoading:!1,debitLoading:!1,billsLoading:!1,currencyOperationLoading:!1,isForeigncurrencyOperation:!1,partnerLoading:!1,dialog:!1,dialogDelete:!1,dialogEntry:!1,search:"",searchCredit:"",searchDebit:"",searchPartner:"",searchCurrency:"",filter:{},sortDesc:!1,page:1,itemsPerPage:15,sortBy:"text",keys:["text","ref","number"],editedIndex:-1,editedItem:{id:"",creditAccount:[],debitAccount:[],partner:"",reference:"",label:"",currency:"",rate:"",amountDebit:[],amountCredit:[],dateBill:new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10),dateDeadline:new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10)},defaultItem:{id:"",creditAccount:[],debitAccount:[],partner:"",reference:"",label:"",currency:"",rate:"",amountDebit:[],amountCredit:[],dateBill:new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10),dateDeadline:new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10)}},lines:{items:[],itemsCopy:[],headers:[{text:"Libellé",align:"start",sortable:!0,value:"label"},{text:"Compte",value:"account"},{text:"Quantité",value:"quantity"},{text:"Prix HT",value:"price"},{text:"Taxes",value:"taxes",sortable:!1},{text:"Prix TTC",value:"priceWithTax"},{text:"",value:"actions",sortable:!1}],loading:!1},taxes:[],total_amount:null,total_taxes:null,minDate:"",maxDate:"",moduleId:"",moduleName:"",currentCurrency:"",currentMonth:"",currentYear:"",rules:{account:[e=>!!e||"Veuillez choisir un compte"],currency:[e=>!!e||"Veuillez choisir une devise"],rate:[e=>!!e||"Veuillez saisir un taux de change"],label:[e=>!!e||"Veuillez saisir un libellé"],slip:[e=>!!e||"Veuillez choisir un type pour la pièce justificative"],reference:[e=>!!e||"Veuillez saisir une référence"],amount:[e=>!!e||"Veuillez saisir un montant",e=>/^-?[0-9]\d*(\.\d+)?$/.test(e)||"Veuillez saisir un nombre"],price:[e=>!!e||"Veuillez saisir un prix",e=>/^-?[0-9]\d*(\.\d+)?$/.test(e)||"Veuillez saisir un nombre"],quantity:[e=>!!e||"Veuillez saisir une quantité",e=>0<e||"Veuillez saisir une quantité supérieure à 0",e=>/^-?[0-9]\d*(\.\d+)?$/.test(e)||"Veuillez saisir un nombre"],date:[e=>!!e||"Veuillez choisir une date"]},tab:null,tabBillLines:null,tablStateBill:null,windowSize:{x:0,y:0},snackbar:!1,multiLine:!1,moduleMenu:!1,snacktext:"",snackcolor:"",timeout:2e3,disableValidate:!0}},watch:{lines:{handler(e,t){const l=e.items;this.total_amount=0;e=this.bill.selectedBill;const r=this.bill.bills[e];r.amount=0,this.total_taxes=0,this.taxes.forEach(t=>{var e=this.bill.entries.findIndex(e=>e.account_id===t.account_id&&e.label===t.name);t.count_selected=0,-1<e&&this.bill.entries.splice(e,1)});l.forEach(a=>{var e,t,i,l;if(this.bill.entries.find(e=>e.line_ref===a.ref).label=a.label,a.taxes_amount.forEach(t=>{var e;void 0===a.taxes.find(e=>t.tax_ref===e)&&(e=a.taxes_amount.findIndex(e=>e.tax_ref===t.tax_ref),a.taxes_amount.splice(e,1))}),!Number.isNaN(parseInt(a.quantity))&&!Number.isNaN(parseFloat(a.price))){const n=parseInt(a.quantity)*parseFloat(a.price);let l=0;Array.from(a.taxes).forEach(t=>{const i=this.taxes.find(e=>e.id===t);i.count_selected+=1;var e=a.taxes.indexOf(t);if(i){switch(i.is_fixed){case!0:switch(i.currency.is_local){case!0:switch(r.currency_is_local){case!0:l+=i.amount;break;case!1:l+=i.amount/r.rate}break;case!1:switch(r.currency_is_local){case!0:l+=i.amount*r.rate;break;case!1:l+=i.amount}}a.taxes_amount[e]={calculated:i.amount,tax_ref:t};break;case!1:0<a.price&&(l+=a.price*(i.amount/100)),a.taxes_amount[e]={calculated:n*(i.amount/100),tax_ref:t}}this.bill.entries.find(e=>e.account_id===i.account_id&&e.label===i.name)||this.bill.entries.push({line_ref:i.id,dateOperation:r.bill_at,account:i.account_name,account_id:i.account_id,label:i.name,amount_foreign:null,debit:null,credit:null})}}),this.total_amount+=n,a.priceWithTax=n+l,this.total_taxes+=l,r.amount+=a.priceWithTax}Number.isNaN(parseFloat(a.price))||(e=this.bill.entries.findIndex(e=>e.line_ref===a.ref),l=this.bill.entries.findIndex(e=>""===e.line_ref),l=this.bill.entries[l],e=this.bill.entries[e],r.currency_is_local?(l.amount_foreign=null,l.amount=r.amount,l.debit=r.amount,e.amount_foreign=null,e.amount=parseFloat(a.price),e.credit=parseFloat(a.price)):(t=r.rate,i=r.amount*t,l.amount_foreign=r.amount,l.amount=i,l.debit=i,l=a.price*t,e.amount_foreign=parseFloat(a.price),e.amount=l,e.credit=parseFloat(l)))}),this.bill.entries.forEach(t=>{const i=this.taxes.find(e=>e.account_id===t.account_id&&e.name===t.label);i&&(t.credit=0,l.forEach(e=>{e.taxes_amount.forEach(e=>{if(e.tax_ref===i.id)switch(r.currency_is_local){case!0:switch(i.currency.is_local){case!0:t.credit+=e.calculated;break;case!1:t.amount_foreign+=e.calculated,t.credit+=e.calculated*r.rate;break;case null:t.amount_foreign=null,t.credit+=e.calculated}break;case!1:switch(i.currency.is_local){case!0:t.credit+=e.calculated;break;case!1:case null:t.amount_foreign+=e.calculated,t.credit+=e.calculated*r.rate}}})}))}),this.disableValidate=0===this.bill.entries.length},deep:!0},selectedBill(e,t){void 0!==e&&(this.lines.items.splice(0),this.bill.entries.splice(0)),this.disableValidate=0===this.bill.entries.length},dialogIncomes(e){e||this.close()},dialogIncomesDelete(e){e||this.closeDelete()}},methods:{capFirst(e){return e[0].toUpperCase()+e.slice(1)},addLinesItem(){let t="";if(Array.from(this.bill.creditAccounts).forEach(e=>{1===e.depth&&(t=e)}),this.lines.items.unshift({ref:Date.now(),label:"",account:t,quantity:1,price:null,taxes:"",taxes_amount:[]}),0===this.bill.entries.length&&1===this.lines.items.length&&(e=this.bill.selectedBill,e=this.bill.bills[e],i=this.lines.items[0],this.bill.entries.push({line_ref:"",dateOperation:e.bill_at,account:e.account,account_id:e.account_id,label:e.reference,amount_foreign:null,debit:null,credit:null}),this.bill.entries.push({line_ref:i.ref,dateOperation:e.bill_at,account:i.account.label,account_id:i.account.id,label:"",amount_foreign:null,debit:null,credit:null})),1<this.lines.items.length){var e=this.bill.selectedBill,i=this.bill.bills[e];const l=this.lines.items[0];this.bill.entries.find(e=>e.line_ref===l.ref)||this.bill.entries.push({line_ref:l.ref,dateOperation:i.bill_at,account:l.account.label,account_id:l.account.id,label:"",amount_foreign:null,debit:null,credit:null})}},getUrlData(){var e=window.location.pathname.split("/");this.moduleName=e[2]},onResize(){this.windowSize={x:window.innerWidth,y:window.innerHeight}},getModule(){this.apiCall("get","/api/settings/journal?type="+this.moduleName).then(e=>{e=e.data;this.moduleId=e.id}).then(()=>{this.getBills()}).then(()=>{this.getDebitAccounts()}).then(()=>{this.getTaxes()})},getBills(){this.bill.billsLoading=!0,this.apiCall("get","/api/billing/customer/bills/get?journal="+this.moduleId).then(e=>{e=e.data;let t=[];Array.from(e).forEach(e=>{t.push({id:e.id,bill_at:this.formatDate(e.bill_at),deadline_at:this.formatDate(e.deadline_at),reference:e.reference,partner_id:e.partner_id,partner:e.partner__name,currency_id:e.currency_id,currency_name:e.currency__name,currency_is_local:e.currency__is_local,rate:e.rate,amount:e.amount,amount_foreign:e.amount_foreign,account_id:e.account_id,account:e.account__account_number+" "+e.account__account_name})}),this.bill.bills=t,this.bill.billsCopy=[...this.bill.bills],this.bill.billsLoading=!1})},getCreditAccounts(){this.bill.creditLoading=!0,this.apiCall("get","/api/accounting/plan/accounts-by-categories/get?categories=produit").then(e=>{e=e.data;let t=[];0<e.length&&(Array.from(e).forEach(e=>{t.push({id:e.id,label:e.account_number+"  "+e.account_name,depth:e.depth})}),this.bill.creditAccounts=t,this.bill.creditCopy=[...this.bill.creditAccounts],this.bill.creditLoading=!1)})},getDebitAccounts(){this.bill.debitLoading=!0,this.apiCall("get",`/api/accounting/journal/${this.moduleId}/get`).then(e=>{e=e.data;let t=[];0<e.length&&(Array.from(e).forEach(e=>{t.push({id:e.id,label:e.account_number+"  "+e.account_name})}),this.bill.debitAccounts=t,this.bill.editedItem.debitAccount=t[0].id,this.bill.defaultItem.debitAccount=t[0].id,this.bill.debitAccountsCopy=[...this.bill.debitAccounts],this.bill.debitLoading=!1)})},getTaxes(){this.apiCall("get","/api/accounting/taxes/get?journal="+this.moduleId).then(e=>{e=e.data;Array.from(e).forEach(e=>{this.taxes.push({id:e.id,name:e.name,account_id:e.account_id,account_number:e.account__account_number,account_name:e.account__account_name,amount:e.amount,currency:{id:e.currency_id,name:e.currency__name,is_local:e.currency__is_local,symbol:e.currency__symbol},is_fixed:e.is_fixed,count_selected:0})})})},getPartners(){this.bill.partnerLoading=!0,this.apiCall("get","/api/billing/partners/get").then(e=>{e=e.data;let t=[];0<e.length&&(Array.from(e).forEach(e=>{t.push({id:e.id,label:""+e.name})}),this.bill.partners=t,this.bill.partnersCopy=[...this.bill.partners],this.bill.partnerLoading=!1)})},savePartner(){var e;""===this.bill.searchPartner?(this.snacktext="Veuillez saisir un nom avant de créer un partenaire",this.snackbar=!0,this.snackcolor="red darken-3"):(e={name:this.bill.searchPartner},this.apiCall("post","/api/billing/partner/save",e).then(e=>{var t=e.data.partner,e=e.data.message;this.bill.partnerloading=!1,this.snacktext=e,this.snackbar=!0,this.bill.partnerLoading=!1,this.snackcolor="green darken-3",this.bill.editedItem.partner=t,this.bill.searchPartner="",this.bill.partners.push(t),this.bill.partnersCopy=this.bill.partners}))},savePartnerAndEdit(){},saveBillEntries(){let e=[];var t=this.bill.selectedBill;const i=this.bill.bills[t];this.bill.entries.forEach(t=>{void 0===this.lines.items.find(e=>e.ref===t.line_ref)&&(null!==t.debit||null!==t.credit||0<t.debit||0<t.credit)&&e.push({id:null,currency:i.currency_id,rate:i.rate,ref_billing_customer:i.id,ref_bill_line:null,account:t.account_id,date_at:i.bill_at,label:i.reference,partner:i.partner_id,amount_foreign:t.amount_foreign,debit:t.debit,credit:t.credit})}),0<e.length&&this.apiCall("post","api/billing/customer/bill/entries/save",e).then(e=>{e.data}).then(()=>{var e={id:i.id,currency:i.currency_id,rate:i.rate,account:i.account_id,dateBill:i.bill_at,dateDeadline:i.deadline_at,partner:i.partner_id,reference:i.reference,amount:i.amount};console.log(e)}),0===this.bill.entries.length&&(this.snackcolor="red darken-4",this.snacktext="Aucune écriture comptable n'a été saisie. \r Commencez par entrer un ligne à à votre facture",this.multiLine=!0,this.snackbar=!0)},getCurrency(){this.bill.currencyOperationLoading=!0,this.apiCall("get","/api/treasury/currencies/get").then(e=>{e=e.data;let t=[];0<e.length&&(Array.from(e).forEach(e=>{e.is_local&&(this.bill.editedItem.currency=e.id,this.bill.defaultItem.currency=e.id),t.push({id:e.id,label:""+e.name,symbol:""+e.symbol,is_local:e.is_local,rate:e.rate})}),this.bill.currencies=t,this.bill.currenciesCopy=[...this.bill.currencies],this.bill.currencyOperationLoading=!1)})},waitUpdate(){this.snackcolor="yellow darken-4",this.snacktext="Est indisponible... veuillez attendre la mise à jour",this.snackbar=!0},searchIncomesCreditAccounts(e){this.bill.searchCredit||(this.bill.creditAccounts=this.bill.creditCopy),this.bill.creditAccounts=this.bill.creditCopy.filter(e=>-1<e.label.toLowerCase().indexOf(this.bill.searchCredit.toLowerCase()))},searchIncomesDebitAccounts(e){this.bill.searchDebit||(this.bill.debitAccounts=this.bill.debitAccountsCopy),this.bill.debitAccounts=this.bill.debitAccountsCopy.filter(e=>-1<e.label.toLowerCase().indexOf(this.bill.searchDebit.toLowerCase()))},searchIncomesPartners(e){this.bill.searchPartner||(this.bill.partners=this.bill.partnersCopy),this.bill.partners=this.bill.partnersCopy.filter(e=>{if(null!=this.bill.searchPartner)return-1<e.label.toLowerCase().indexOf(this.bill.searchPartner.toLowerCase())})},searchIncomesCurrencies(e){this.bill.searchCurrency||(this.bill.currencies=this.bill.currenciesCopy),this.bill.currencies=this.bill.currenciesCopy.filter(e=>{if(null!=this.bill.searchCurrency)return-1<e.label.toLowerCase().indexOf(this.bill.searchCurrency.toLowerCase())})},formatDate(e){var t,i;return e?([e,t,i]=e.split("-"),i+`/${t}/`+e):null},parseDate(e){var t,i;return e?([e,t,i]=e.split("/"),`${t.padStart(2,"0")}-${e.padStart(2,"0")}-`+i):null},thousandSeparator(e){return null===e?null:(e=parseFloat(e).toFixed(2),parseFloat(e).toLocaleString("fr-FR"))},setOperationDate(){var[,,,]=new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10).split("-")},apiCall(e,t,i){return"get"===e?axios.get(t):"post"===e?axios.post(t,i):void 0},editItem(e){this.bill.editedIndex=this.bill.entries.indexOf(e),this.bill.editedItem=Object.assign({},e),this.bill.dialog=!0},deleteItem(e,t){this.lines.items.splice(e,1),0===this.lines.items.length&&this.bill.entries.splice(0);e=this.bill.entries.findIndex(e=>e.line_ref===t.ref);this.bill.entries.splice(e,1)},deleteItemConfirm(){var e=this.bill.editedItem.id,e=(this.bill.loading=!0,{id:e});this.apiCall("post","/api/accounting/main/delete",e).then(e=>{this.bill.loading=!1,this.snacktext=e.data.message,this.snackbar=!0,this.snackcolor="green darken-3",this.bill.entries.splice(this.bill.editedIndex,1),this.bill.dialogDelete=!1})},close(){this.bill.dialog=!1,this.$nextTick(()=>{this.bill.editedItem=Object.assign({},this.bill.defaultItem),this.bill.editedIndex=-1})},closeDelete(){this.bill.dialogDelete=!1,this.$nextTick(()=>{this.bill.editedItem=Object.assign({},this.bill.defaultItem),this.bill.editedIndex=-1})},closeDialogEntry(){this.bill.dialogEntry=!1,this.$nextTick(()=>{this.bill.editedItem={id:"",creditAccount:[],debitAccount:[],partner:"",reference:"",label:"",amountDebit:[],amountCredit:[],dateBill:new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString().substr(0,10)},this.bill.editedItem.debitAccount[0]=this.bill.defaultItem.debitAccount[0],this.bill.editedIndex=-1,this.bill.countDebitAccount=1,this.bill.countCreditAccount=1})},setData(){return{id:this.bill.editedItem.id,currency:this.bill.editedItem.currency,rate:this.bill.editedItem.rate,account:this.bill.editedItem.debitAccount,dateBill:this.bill.editedItem.dateBill,dateDeadline:this.bill.editedItem.dateDeadline,partner:this.bill.editedItem.partner,reference:this.bill.editedItem.reference}},saveAndClose(){var e;-1<this.bill.editedItem.editedIndex?(this.bill.loading=!0,this.setData()):(e=this.setData(),this.$refs.formBill.validate()&&(this.bill.loading=!0,this.apiCall("post","/api/billing/customer/bill/save",e).then(e=>{e=e.data.message;this.snacktext=e,this.snackcolor="green darken-3",this.bill.dialogEntry=!1,this.snackbar=!0,this.bill.loading=!1,this.$nextTick(()=>{this.bill.editedItem=Object.assign({},this.bill.defaultItem),this.bill.editedIndex=-1})}).catch(e=>{e=e.response.data.message;this.bill.loading=!1,this.snacktext=e,this.snackbar=!0,this.snackcolor="red darken-3"})))},saveAndContinue(){var e;-1<this.bill.editedIndex?(this.bill.loading=!0,this.setData()):(e=this.setData(),this.$refs.formBill.validate()&&(this.bill.loading=!0,this.apiCall("post","/api/billing/customer/bill/save",e).then(e=>{e=e.data.message;this.snacktext=e,this.snackcolor="green darken-3",this.snackbar=!0,this.bill.loading=!1,this.$nextTick(()=>{this.bill.editedItem=Object.assign({},this.bill.defaultItem),this.bill.editedIndex=-1})}).catch(e=>{e=e.response.data.message;this.bill.loading=!1,this.snacktext=e,this.snackbar=!0,this.snackcolor="red darken-3",this.bill.dialog=!1})))},nextPage(){this.page+1<=this.numberOfPages&&(this.page+=1)},formerPage(){1<=this.page-1&&--this.page}},computed:{formTitle(){return-1===this.bill.editedIndex?"Nouveau Compte":"Modifier Compte"},selectedBill(){return this.bill.selectedBill},getBillLines(){var e=this.bill.selectedBill;const t=this.bill.bills[e];void 0!==t&&(this.lines.loading=!0,this.apiCall("get","/api/billing/customer/bill/lines/get?billId="+t.id).then(e=>{e=e.data;let t=[];Array.from(e).forEach(e=>{t.push({id:e.id,account:e.account__account_number+" "+e.account__account_name,label:e.label})}),this.lines.items=t,this.lines.loading=!1}).then(()=>{this.apiCall("get",`/api/billing/customer/bill/${t.id}/accounting/entries/get`).then(e=>{e=e.data;let t=[];Array.from(e).forEach(e=>{t.push({id:e.id,dateOperation:this.formatDate(e.date_at),account:e.account_number+" "+e.account_name,label:e.label,amount_foreign:e.amount_foreign,debit:e.debit,credit:e.credit,rate:e.rate,currency_is_local:e.currency_is_local,partner:e.partner_name,is_verified:e.is_verified})}),this.bill.entries=t})}))},partnerPlaceholder(){return 0===this.bill.partners.length?"Exemple: Remya Tshipamba":"Rechercher partenaire"},partnerLabel(){return 0===this.bill.partners.length&&"Créer un partenaire"},symbolCurrency(){let t;return Array.from(this.bill.currencies).forEach(e=>{e.id===this.bill.editedItem.currency&&(t=e.symbol.toUpperCase(),e.is_local?(this.bill.isForeigncurrencyOperation=!1,this.bill.editedItem.rate=null):(this.bill.isForeigncurrencyOperation=!0,this.bill.editedItem.rate=e.rate))}),"Montant en "+t},computedDateBillFormatted(){return this.formatDate(this.bill.editedItem.dateBill)},computedDateDeadlineFormatted(){return this.formatDate(this.bill.editedItem.dateDeadline)},numberOfPages(){return Math.ceil(this.items.length/this.itemsPerPage)},filteredKeys(){return this.keys.filter(e=>"Name"!==e)},...Pinia.mapState(currencyStore,["currency_asset"])},created(){this.getUrlData(),this.getCurrency(),this.getModule(),this.setOperationDate(),this.getCreditAccounts(),this.getPartners()},mounted(){this.onResize(),this.bill.selectedBill=void 0}});